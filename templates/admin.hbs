<div x-data="endTimeToggle()"
     x-init="init()">
    <section id="timeselector"
             class="leisure-card mb-2 mx-auto py-2 mw-800">
        <h2 class="text-center mb-2 fs-2xl">Zeitauswahl</h2>
        <form hx-get="/admin"
              hx-target="#main-content"
              hx-push-url="true"
              class="container text-center"
              @submit="handleSubmit">
            <datalist id="spg_times_list">
                {{#each spg_times}}
                    <option value="{{this}}"></option>
                {{/each}}
            </datalist>
            <div class="row mt-1 g-2 align-items-center">
                <div class="col-md-6">
                    <label class="form-label fw-bold text-uppercase fs-sm ls-normal"> START Time <input type="text"
                               name="starttime"
                               class="form-control form-control-sm text-center"
                               id="timestartselect"
                               list="spg_times_list"
                               value="{{starttime}}">
                    </label>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold text-uppercase fs-sm ls-normal"> Start Date <input type="date"
                               name="startdate"
                               class="form-control form-control-sm text-center"
                               value="{{startdate}}">
                    </label>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col text-center">
                    <div
                         class="form-check form-switch d-inline-flex align-items-center gap-2 p-2 fs-lg bg-white-90 border border-2 rounded-4-lg cursor-pointer">
                        <input class="form-check-input m-0"
                               type="checkbox"
                               id="toggleEndTime"
                               x-model="showEndTime"
                               @change="savePreference()">
                        <label class="form-check-label fw-bold m-0 cursor-pointer"
                               for="toggleEndTime">Endzeit festlegen</label>
                    </div>
                </div>
            </div>
            <div class="row mt-2 g-2 align-items-center"
                 x-show="showEndTime"
                 x-transition
                 x-cloak>
                <div class="col-md-6">
                    <label class="form-label fw-bold text-uppercase fs-sm ls-normal"> End Time <input type="text"
                               name="endtime"
                               class="form-control form-control-sm text-center"
                               id="timeendselect"
                               list="spg_times_list"
                               value="{{endtime}}">
                    </label>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold text-uppercase fs-sm ls-normal"> End Date <input type="date"
                               name="enddate"
                               class="form-control form-control-sm text-center"
                               value="{{enddate}}">
                    </label>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col">
                    <input type="submit"
                           class="btn btn-info w-100 py-1 fs-lg"
                           value="Suchen">
                </div>
            </div>
        </form>
    </section>
    <script>
        function endTimeToggle() {
            return {
                showEndTime: false,
                endFields: ["endtime", "enddate"],

                init() {
                    const saved = localStorage.getItem('adminShowEndTime');
                    this.showEndTime = saved === 'true';

                    if (saved === null) {
                        this.showEndTime = false;
                    }

                    if (!this.showEndTime) {
                        this.disableEndFields();
                    }

                },

                savePreference() {
                    localStorage.setItem('adminShowEndTime', this.showEndTime);
                    if (this.showEndTime) {
                        this.enableEndFields();
                    } else {
                        this.disableEndFields();
                    }
                },

                handleSubmit(event) {
                    if (!this.showEndTime) {
                        this.disableEndFields();
                        return;
                    }

                    const form = event.target;
                    const endtimeInput = form.querySelector('[name="endtime"]');
                    const enddateInput = form.querySelector('[name="enddate"]');
                    const endtimeValue = endtimeInput ? endtimeInput.value.trim() : "";
                    const enddateValue = enddateInput ? enddateInput.value.trim() : "";

                    if (!endtimeValue && !enddateValue) {
                        this.disableEndFields();
                    }
                },

                disableEndFields() {
                    this.endFields.forEach((name) => {
                        const input = document.querySelector(`[name="${name}"]`);
                        if (input) {
                            input.disabled = true;
                        }
                    });
                },

                enableEndFields() {
                    this.endFields.forEach((name) => {
                        const input = document.querySelector(`[name="${name}"]`);
                        if (input) {
                            input.disabled = false;
                        }
                    });
                }
            }
        }
    </script>
    <div class="container text-center mb-4 mt-2 d-flex justify-content-center gap-3 flex-wrap">
        <a href="/admin/download-abgaben" class="btn btn-success fw-bold fs-lg px-4 py-2 shadow-sm" download>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-file-earmark-zip me-2" viewBox="0 0 16 16">
                <path d="M5 7.5a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v.938l.4 1.599a1 1 0 0 1-.416 1.074l-.93.62a1 1 0 0 1-1.11 0l-.929-.62a1 1 0 0 1-.415-1.074L5 8.438zm2 0H6v.938a1 1 0 0 1-.03.243l-.4 1.598.93.62.93-.62-.4-1.598a1 1 0 0 1-.03-.243z"/>
                <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5z"/>
            </svg>
            Abgaben & Datenbank herunterladen (ZIP)
        </a>
        <button hx-post="/admin/wipe-abgaben"
                hx-confirm="Sind Sie sicher, dass Sie ALLE Abgaben unwiderruflich löschen möchten?"
                hx-target="#wipe-result"
                class="btn btn-danger fw-bold fs-lg px-4 py-2 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-trash3 me-2" viewBox="0 0 16 16">
                <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/>
            </svg>
            Abgaben-Verzeichnis leeren
        </button>
    </div>
    <div id="wipe-result"></div>
    {{> admin-report}}
</div>