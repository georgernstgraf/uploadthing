{{> top}}
<div x-data="endTimeToggle()"
     x-init="init()">
    <section id="timeselector"
             class="leisure-card mb-5 mx-auto"
             style="max-width: 800px;">
        <h2 class="text-center mb-4">Zeitauswahl</h2>
        <form action="forensic"
              method="get"
              class="container text-center">
            <div class="row mt-2 g-3 align-items-center">
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-uppercase letter-spacing-1">START Time</label>
                    <input type="text"
                           name="starttime"
                           class="form-control text-center"
                           id="timestartselect"
                           value="{{starttime}}"
                           style="background: white;">
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-uppercase letter-spacing-1">Start Date</label>
                    <input type="date"
                           name="startdate"
                           class="form-control text-center"
                           value="{{startdate}}"
                           style="background: white;">
                </div>
            </div>
            <!-- Toggle for End Time -->
            <div class="row mt-4">
                <div class="col text-center">
                    <div class="form-check form-switch d-inline-block p-2 rounded-pill bg-white shadow-sm pe-4 ps-5">
                        <input class="form-check-input"
                               type="checkbox"
                               id="toggleEndTime"
                               x-model="showEndTime"
                               @change="savePreference()"
                               style="cursor: pointer;">
                        <label class="form-check-label fw-bold ms-2"
                               for="toggleEndTime"
                               style="cursor: pointer;">Endzeit festlegen</label>
                    </div>
                </div>
            </div>
            <!-- Conditional End Time Section -->
            <div class="row mt-3 g-3 align-items-center"
                 x-show="showEndTime"
                 x-transition
                 x-cloak>
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-uppercase letter-spacing-1">End Time</label>
                    <input type="text"
                           name="endtime"
                           class="form-control text-center"
                           id="timeendselect"
                           value="{{endtime}}"
                           style="background: white;">
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-uppercase letter-spacing-1">End Date</label>
                    <input type="date"
                           name="enddate"
                           class="form-control text-center"
                           value="{{enddate}}"
                           style="background: white;">
                </div>
            </div>
            <div class="row mt-4">
                <div class="col">
                    <input type="submit"
                           class="btn btn-primary w-100 py-2 fs-5"
                           value="Suchen">
                </div>
            </div>
        </form>
    </section>
    <!-- Alpine.js Component for End Time Toggle -->
    <script>
        function endTimeToggle() {
            return {
                showEndTime: false,

                init() {
                    // Load preference from LocalStorage
                    const saved = localStorage.getItem('forensicShowEndTime');
                    this.showEndTime = saved === 'true';

                    // If no preference saved, default to false (hidden)
                    if (saved === null) {
                        this.showEndTime = false;
                    }
                },

                savePreference() {
                    localStorage.setItem('forensicShowEndTime', this.showEndTime);
                }
            }
        }
    </script>
    <section class="container"
             id="report">
        <h2 class="text-center mb-1">SchülerInnen und IP Adressen</h2>
        <h5 class="text-center text-muted mb-5">
            Zeitraum: {{#unless within12hours}}
                {{startdate}}
            {{/unless}}
            {{starttime}} - <span x-show="showEndTime"
                  x-cloak>{{#unless within12hours}}
                    {{enddate}}
                {{/unless}}
                {{endtime}}
            </span>
        </h5>

        <!-- Table 1: IPs with registered names -->
        <h4 class="text-center mt-4 mb-3 fw-bold text-uppercase letter-spacing-1 border-bottom pb-2 d-inline-block mx-auto" style="border-color: var(--leisure-primary) !important;">Registrierte IP-Adressen</h4>
        <ul class="list-unstyled mt-3 text-start d-flex flex-column gap-3">
            {{#each ips_with_name}}
                <li class="row">
                    {{#let (get @root.ip2users this.ip) as |user|}}
                        <details class="col leisure-card p-3 mb-0" style="background: rgba(255,255,255,0.8);">
                            <summary class="fw-bold" style="cursor: pointer; list-style: none;">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px;">
                                            {{user.name.[0]}}
                                        </div>
                                        <div>
                                            <span class="d-block">{{user.name}}</span>
                                            <span class="small text-muted fw-normal">{{this.ip}}</span>
                                        </div>
                                    </div>
                                    <div class="badge bg-light text-dark border">
                                        {{this.count}}x
                                        <span class="d-none d-sm-inline ms-1 text-muted fw-normal">| {{this.lastseen}}</span>
                                    </div>
                                </div>
                            </summary>
                            <div class="row mt-4 pt-3 border-top">
                                <h5 class="text-center w-100 mb-3 small text-uppercase fw-bold text-muted">Historie</h5>
                                <div class="col-md-6 border-end">
                                    <div class="fw-bold text-center mb-2 text-primary">{{user.name}}</div>
                                    <ul class="list-unstyled p-1 small">
                                        {{#each (get @root.user_history user.email) }}
                                            <li class="mb-1 border-bottom pb-1"><span class="text-muted">{{this.at}}</span> ➔ {{this.ip}}</li>
                                        {{/each}}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <div class="fw-bold text-center mb-2 text-primary">{{this.ip}}</div>
                                    <ul class="list-unstyled p-1 small">
                                        {{#each (get @root.ip_history this.ip) }}
                                            <li class="mb-1 border-bottom pb-1"><span class="text-muted">{{this.at}}</span> ➔ {{this.name}}</li>
                                        {{/each}}
                                    </ul>
                                </div>
                            </div>
                        </details>
                    {{/let}}
                </li>
            {{else}}
                <li class="text-center text-muted fst-italic py-4">Keine registrierten IP-Adressen in diesem Zeitraum gefunden.</li>
            {{/each}}
        </ul>

        <!-- Table 2: IPs without registered names -->
        <h4 class="text-center mt-5 mb-3 fw-bold text-uppercase letter-spacing-1 border-bottom pb-2 d-inline-block mx-auto" style="border-color: var(--leisure-secondary) !important;">Nicht registrierte IP-Adressen</h4>
        <ul class="list-unstyled mt-3 text-start d-flex flex-column gap-3">
            {{#each ips_without_name}}
                <li class="row">
                    <details class="col leisure-card p-3 mb-0" style="background: rgba(255,255,255,0.6);">
                        <summary class="fw-bold" style="cursor: pointer; list-style: none;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px;">
                                        ?
                                    </div>
                                    <div>
                                        <span class="d-block">{{this.ip}}</span>
                                        <span class="small text-muted fw-normal">Unbekannt</span>
                                    </div>
                                </div>
                                <div class="badge bg-light text-dark border">
                                    {{this.count}}x
                                    <span class="d-none d-sm-inline ms-1 text-muted fw-normal">| {{this.lastseen}}</span>
                                </div>
                            </div>
                        </summary>
                        <div class="row mt-4 pt-3 border-top">
                            <h5 class="text-center w-100 mb-3 small text-uppercase fw-bold text-muted">Historie</h5>
                            <div class="col-md-6 border-end">
                                <div class="fw-bold text-center mb-2 text-muted">Kein Benutzer</div>
                                <p class="text-muted text-center small fst-italic">Für diese IP-Adresse ist kein Benutzer registriert.</p>
                            </div>
                            <div class="col-md-6">
                                <div class="fw-bold text-center mb-2 text-primary">{{this.ip}}</div>
                                <ul class="list-unstyled p-1 small">
                                    {{#each (get @root.ip_history this.ip) }}
                                        <li class="mb-1 border-bottom pb-1"><span class="text-muted">{{this.at}}</span> ➔ {{this.name}}</li>
                                    {{/each}}
                                </ul>
                            </div>
                        </div>
                    </details>
                </li>
            {{else}}
                <li class="text-center text-muted fst-italic py-4">Keine nicht registrierten IP-Adressen in diesem Zeitraum gefunden.</li>
            {{/each}}
        </ul>
    </section>
</div>
</main>
</body>

</html>