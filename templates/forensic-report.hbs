<section class="container"
         id="report"
         hx-get="/forensic"
         hx-trigger="load, every {{forensic_refresh_seconds}}s"
         hx-target="#report"
         hx-swap="innerHTML"
         hx-select="#report > *"
         hx-include="#timeselector form">
    <h2 class="text-center mb-0 fs-2xl">SchülerInnen und IP Adressen</h2>
    <h6 class="text-center text-muted mb-2 fs-sm"> Zeitraum: {{#unless withinTimeCutoff}}
            {{startdate}}
        {{/unless}}
        {{starttime}} - {{#if endtimeInFuture}} jetzt {{else}}
            <span x-show="showEndTime"
                  x-cloak>
                {{enddate}}
                {{endtime}}
            </span>
        {{/if}}
    </h6>
    <!-- Table 1: IPs with registered names -->
    <h5 class="text-center mt-2 mb-1 fw-bold text-uppercase border-bottom pb-1 d-inline-block mx-auto section-heading border-primary">Registrierte IP-Adressen</h5>
    <div class="row row-cols-1 row-cols-lg-2 row-cols-xl-3 g-1 mt-1">
        {{#each ips_with_name}}
            <div class="col">
                <details class="h-100 leisure-card p-2 mb-0 d-flex flex-column {{#if this.is_stale}}forensic-stale{{/if}} {{#if this.has_submission}}forensic-submitted{{/if}} bg-white-20">
                    <summary class="fw-bold cursor-pointer list-none">
                        <div class="d-flex align-items-center justify-content-between w-100">
                            <div class="d-flex align-items-center gap-1 overflow-hidden">
                                <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 size-26 fs-sm fw-bold initial-avatar">
                                    {{#if this.registrations.[0].user}}
                                        {{givenNameInitial this.registrations.[0].user.name}}
                                    {{else}} ? {{/if}}
                                </div>
                                <div class="overflow-hidden">
                                    <span class="d-block text-truncate fs-base"
                                          title="{{this.registrations.[0].user.name}}">
                                        {{#if this.registrations.[0].user}}
                                            {{this.registrations.[0].user.name}}
                                        {{else}} Unbekannt {{/if}}
                                    </span>
                                    <span class="text-muted fw-normal d-block text-truncate fs-sm">{{this.ip}}</span>
                                </div>
                            </div>
                            <div class="badge bg-light text-dark border ms-1 flex-shrink-0 fs-sm">
                                {{this.seen_count}}x
                            </div>
                        </div>
                        <div class="text-muted fw-normal mt-0 text-end fs-xs"> zuletzt: {{this.seen_at_desc.[0]}}
                        </div>
                    </summary>
                    <div class="mt-2 pt-2 border-top flex-grow-1">
                        <h6 class="text-center w-100 mb-1 text-uppercase fw-bold text-muted fs-xs">Historie</h6>
                        <div class="row g-1">
                            <div class="col-12">
                                <div class="fw-bold text-center mb-1 fs-sm text-leisure-primary">Registrierungen</div>
                                <ul class="list-unstyled p-1 rounded mb-1 forensic-list-bg">
                                    {{#each this.registrations}}
                                        <li class="mb-0 border-bottom pb-1 px-1 d-flex justify-content-between forensic-item">
                                            <span class="text-muted">{{this.at}}</span>
                                            <span class="history-item-ip">
                                                {{#if this.user}}
                                                    {{this.user.name}}
                                                {{else}} Unbekannt {{/if}}
                                            </span>
                                        </li>
                                    {{/each}}
                                </ul>
                            </div>
                            {{#if this.submissions.length}}
                                <div class="col-12">
                                    <div class="fw-bold text-center mb-1 fs-sm text-leisure-primary">Abgaben</div>
                                    <ul class="list-unstyled p-1 rounded mb-1 forensic-list-bg">
                                        {{#each this.submissions}}
                                            <li class="mb-0 border-bottom pb-1 px-1 d-flex justify-content-between forensic-item">
                                                <span class="text-muted">{{this.at}}</span>
                                                <span class="history-item-ip">{{this.filename}}</span>
                                            </li>
                                        {{/each}}
                                    </ul>
                                </div>
                            {{/if}}
                            <div class="col-12">
                                <div class="fw-bold text-center mb-1 fs-sm text-leisure-primary">IP: {{this.ip}}</div>
                                <ul class="list-unstyled p-1 rounded forensic-list-bg">
                                    {{#each this.seen_at_desc }}
                                        <li class="mb-0 border-bottom pb-1 px-1 d-flex justify-content-between forensic-item">
                                            <span class="text-muted">{{this}}</span>
                                        </li>
                                    {{/each}}
                                </ul>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        {{else}}
            <div class="col-12 text-center text-muted fst-italic py-2 fs-base">Keine registrierten IP-Adressen in diesem Zeitraum gefunden.</div>
        {{/each}}
    </div>
    <!-- Table 2: IPs without registered names -->
    <h5 class="text-center mt-3 mb-1 fw-bold text-uppercase border-bottom pb-1 d-inline-block mx-auto section-heading border-secondary">Nicht registrierte IP-Adressen</h5>
    <div class="row row-cols-1 row-cols-lg-2 row-cols-xl-3 g-1 mt-1">
        {{#each ips_without_name}}
            <div class="col">
                <details class="h-100 leisure-card p-2 mb-0 d-flex flex-column bg-white-70">
                    <summary class="fw-bold cursor-pointer list-none">
                        <div class="d-flex align-items-center justify-content-between w-100">
                            <div class="d-flex align-items-center gap-1 overflow-hidden">
                                <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 size-26 fs-sm fw-bold initial-avatar-muted">
                                    ? </div>
                                <div class="overflow-hidden">
                                    <span class="d-block text-truncate fs-base">{{this.ip}}</span>
                                    <span class="text-muted fw-normal fs-sm">Unbekannt</span>
                                </div>
                            </div>
                            <div class="badge bg-light text-dark border ms-1 flex-shrink-0 fs-sm">
                                {{this.seen_count}}x
                            </div>
                        </div>
                        <div class="text-muted fw-normal mt-0 text-end fs-xs"> zuletzt: {{this.seen_at_desc.[0]}}
                        </div>
                    </summary>
                    <div class="mt-2 pt-2 border-top flex-grow-1">
                        <h6 class="text-center w-100 mb-1 text-uppercase fw-bold text-muted fs-xs">Historie</h6>
                        <div class="row g-1">
                            <div class="col-12">
                                <div class="fw-bold text-center mb-1 text-muted fs-sm">Kein Benutzer</div>
                                <p class="text-muted text-center fst-italic mb-1 fs-xs">Für diese IP ist kein Benutzer registriert.</p>
                            </div>
                            <div class="col-12">
                                <div class="fw-bold text-center mb-1 fs-sm text-leisure-primary">IP: {{this.ip}}</div>
                                <ul class="list-unstyled p-1 rounded forensic-list-bg">
                                    {{#each this.seen_at_desc }}
                                        <li class="mb-0 border-bottom pb-1 px-1 d-flex justify-content-between forensic-item">
                                            <span class="text-muted">{{this}}</span>
                                            <span class="history-item-user">Unbekannt</span>
                                        </li>
                                    {{/each}}
                                </ul>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        {{else}}
            <div class="col-12 text-center text-muted fst-italic py-2 fs-base">Keine nicht registrierten IP-Adressen in diesem Zeitraum gefunden.</div>
        {{/each}}
    </div>
</section>
<script>
    document.addEventListener("htmx:beforeRequest", (event) => {
        const trigger = event.detail.elt;
        if (!trigger || !trigger.closest("#report")) {
            return;
        }
        if (document.querySelector("#report details[open]")) {
            event.preventDefault();
        }
    });
</script>
